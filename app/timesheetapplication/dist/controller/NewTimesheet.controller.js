sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/core/Fragment","sap/m/MessageBox"],function(e,t,a,s,r){"use strict";var o=this;return e.extend("timesheetapplication.controller.NewTimesheet",{onInit:function(){o.array=[];o.oGmodel=this.getOwnerComponent().getModel("oGmodel");this.getOwnerComponent().getRouter().getRoute("NewTimesheet").attachPatternMatched(this._onPatternMatched,this)},_onPatternMatched:function(e){var a=this.getView();this.getDateRanges();this.oGmodel=this.getOwnerComponent().getModel("oGmodel");if(!o.oGmodel.oData["loggedInUser"]){this.getOwnerComponent().getRouter().navTo("RouteView");return}o.sDateRange=e.getParameter("arguments").dateRange;o.Status=e.getParameter("arguments").Status;o.Sdate=e.getParameter("arguments").Sdate;o.Ssubmit=e.getParameter("arguments").submit;var s=new Date(o.Sdate);var r=String(s.getDate()).padStart(2,"0");var i=String(s.getMonth()+1).padStart(2,"0");var n=s.getFullYear();var l=r+"-"+i+"-"+n;o.sName=e.getParameter("arguments").Name;var g=new sap.ui.model.json.JSONModel;this.getView().setModel(g,"ostatusModel");this.getView().getModel("ostatusModel").setProperty("/Status",o.Status);this.getView().getModel("ostatusModel").setProperty("/SubName",o.Ssubmit);this.getView().getModel("ostatusModel").setProperty("/SubDate",l);var d=o.oGmodel.oData.odata.MANAGERFLAG;var u=this.oGmodel.oData.loggedInUser.FullName;this.getView().byId("dateRangeComboBox").setSelectedKey("");if(o.Status==="Submitted"&&d==="Yes"){this.getView().mAggregations.content[0].mAggregations.pages[0].mAggregations.footer.removeStyleClass("classFooterHidden").addStyleClass("classFooterVisible");this.getView().byId("idsavebtn").setVisible(false);this.getView().byId("idsubmitforapproval").setVisible(false);this.getView().byId("idapproval").setVisible(true);this.getView().byId("iddelete").setVisible(true);this.getView().byId("Addiconbtn").setVisible(false);this.getView().byId("dateRangeComboBox").setSelectedKey(o.sDateRange);this.getView().byId("dateRangeComboBox").setEnabled(false);var h=this.oGmodel.oData["loggedInUser"].Email;this.getView().byId("statusvisible").setVisible(true);this.getView().byId("subdatevisible").setVisible(true);this.getView().byId("substatusvisible").setVisible(true)}else if(o.Status==="Saved"){this.getView().mAggregations.content[0].mAggregations.pages[0].mAggregations.footer.removeStyleClass("classFooterHidden").addStyleClass("classFooterVisible");this.getView().byId("idsavebtn").setVisible(true);this.getView().byId("idsubmitforapproval").setVisible(true);this.getView().byId("idapproval").setVisible(false);this.getView().byId("Addiconbtn").setVisible(true);this.getView().byId("dateRangeComboBox").setEnabled(true);this.getView().byId("dateRangeComboBox").setSelectedKey(o.sDateRange);this.getView().byId("statusvisible").setVisible(true);this.getView().byId("subdatevisible").setVisible(true);this.getView().byId("substatusvisible").setVisible(true);this.getView().byId("iddelete").setVisible(false);var h=this.oGmodel.oData["loggedInUser"].Email}else if(o.Status==="Approved"){this.getView().mAggregations.content[0].mAggregations.pages[0].mAggregations.footer.removeStyleClass("classFooterVisible").addStyleClass("classFooterHidden");this.getView().byId("Addiconbtn").setVisible(false);this.getView().byId("dateRangeComboBox").setSelectedKey(o.sDateRange);this.getView().byId("dateRangeComboBox").setEnabled(false);this.getView().byId("statusvisible").setVisible(true);this.getView().byId("subdatevisible").setVisible(true);this.getView().byId("substatusvisible").setVisible(true);this.getView().byId("iddelete").setVisible(false)}else if(o.Status==="Submitted"&&d==="No"){this.getView().mAggregations.content[0].mAggregations.pages[0].mAggregations.footer.removeStyleClass("classFooterVisible").addStyleClass("classFooterHidden");this.getView().byId("Addiconbtn").setVisible(false);this.getView().byId("dateRangeComboBox").setSelectedKey(o.sDateRange);this.getView().byId("dateRangeComboBox").setEnabled(false);this.getView().byId("statusvisible").setVisible(true);this.getView().byId("subdatevisible").setVisible(true);this.getView().byId("substatusvisible").setVisible(true);this.getView().byId("iddelete").setVisible(false)}else{this.getView().mAggregations.content[0].mAggregations.pages[0].mAggregations.footer.removeStyleClass("classFooterHidden").addStyleClass("classFooterVisible");this.getView().byId("idsavebtn").setVisible(true);this.getView().byId("idsubmitforapproval").setVisible(true);this.getView().byId("idapproval").setVisible(false);this.getView().byId("Addiconbtn").setVisible(true);this.getView().byId("dateRangeComboBox").setSelectedKey(o.sDateRange);this.getView().byId("dateRangeComboBox").setEnabled(true);this.getView().byId("statusvisible").setVisible(false);this.getView().byId("subdatevisible").setVisible(false);this.getView().byId("substatusvisible").setVisible(false);this.getView().byId("iddelete").setVisible(false);var h=e.getParameter("arguments").sEmail;var u=this.oGmodel.oData.loggedInUser.FullName}if(o.sDateRange==="D"){var m=new t({array:this.oGmodel.oData.odata.results});o.oModel=new t({currentStartDate:null,allocations:[{Type:"",project:"",Phase:"",description:"",hours:{mon:"0",tue:"0",wed:"0",thu:"0",fri:"0",sat:"0",sun:"0"},totalHours:"0",AvailableHours:"0",hidingProjNam:true,isDeleteButtonVisible:false,flags:{hidingTextarea:true,hidingTotalInt:false}},{Type:"",project:"",Phase:"",description:"",hours:{mon:"0",tue:"0",wed:"0",thu:"0",fri:"0",sat:"0",sun:"0"},totalHours:"0",hidingProjNam:false,isDeleteButtonVisible:false,flags:{hidingTextarea:false,hidingTotalInt:true}}],dateRanges:this.getDateRanges(),dates:["","","","","","",""],isHoliday:{mon:true,tue:true,wed:true,thu:true,fri:true,sat:true,sun:true},holidayName:{mon:"",tue:"",wed:"",thu:"",fri:"",sat:"",sun:""}});this.getView().setModel(o.oModel)}else{this.loadData()}this.byId("FullName").setText(o.oGmodel.oData.loggedInUser.FullName);var m=new t({array:o.oGmodel.oData.odata});this.loadProjectData();if(!o.oGmodel.oData["loggedInUser"]){this.getOwnerComponent().getRouter().navTo("Loginpage");return}},onProjectSelectionChange:function(e){var t=this.getOwnerComponent().getModel("oModel");var s=e.getParameter("selectedItem");var r=s.getKey();var o={ProjectID:r};new Promise(function(e,a){t.callFunction("/AvailableHours",{method:"GET",urlParameters:o,success:function(t,a){var s=t.AvailableHours.AvailableHours;e(s)},error:function(e){console.error("Error retrieving available hours:",e);a(e)}})}).then(function(t){e.getParameters().selectedItem.getBindingContext().getObject().AvailableHours=t;this.getView().getModel().refresh(true)}.bind(this)).catch(function(e){a.show("Error retrieving available hours:",e)})},getDateRanges:function(){o.dateRanges=[];var e=new Date;var t=new Date(e);t.setMonth(e.getMonth()-3);var a=new Date(e);a.setMonth(e.getMonth()+3);while(t<=a){var s=this._getMonday(t);var r=new Date(s);r.setDate(r.getDate()+6);var i=this._formatDate(s);var n=this._formatDate(r);var l=`${i}, ${s.getFullYear()} - ${n}, ${r.getFullYear()}`;o.dateRanges.push({key:l,text:l});t.setDate(t.getDate()+7)}return dateRanges},_formatDate:function(e){var t={month:"short",day:"numeric"};return e.toLocaleDateString("en-US",t)},_getMonday:function(e){var t=new Date(e);var a=t.getDay();var s=t.getDate()-a+(a===0?-6:1);return new Date(t.setDate(s))},onDateRangeChange:function(e){var t=e.getParameter("selectedItem").getText();var a=t.split(" - ")[0];var s=new Date(a);this.getView().getModel().setProperty("/currentStartDate",s);this._updateWeek()},formatDateToISO:function(e){var t=e.getFullYear();var a=String(e.getMonth()+1).padStart(2,"0");var s=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${s}`},_updateWeek:function(){var e=this.getView().getModel();var t=e.getProperty("/currentStartDate");var a=[];var s={mon:true,tue:true,wed:true,thu:true,fri:true,sat:true,sun:true};var r={mon:"",tue:"",wed:"",thu:"",fri:"",sat:"",sun:""};var o=[];if(t){for(var i=0;i<7;i++){var n=new Date(t);n.setDate(t.getDate()+i);var l=this.formatDateToISO(n);o.push({date:l});a.push(this._formatDate(n))}}else{a=["","","","","","",""]}var g=JSON.stringify(o);this.holidaycheck(g,o,a,s,r,e)},holidaycheck:function(e,t,a,s,r,o){var i=this.getOwnerComponent().getModel("oModel");i.callFunction("/HolidayCheck",{method:"GET",urlParameters:{dates:e},success:function(e,i){var n=JSON.parse(e.HolidayCheck);if(n.length>0){n.forEach(function(e){var a=e.Date.split("T")[0];var o=e.HoildayName;t.forEach(function(e,t){if(e.date===a){switch(t){case 0:s.mon=false;r.mon=o;break;case 1:s.tue=false;r.tue=o;break;case 2:s.wed=false;r.wed=o;break;case 3:s.thu=false;r.thu=o;break;case 4:s.fri=false;r.fri=o;break;case 5:s.sat=false;r.sat=o;break;case 6:s.sun=false;r.sun=o;break}}})})}o.setProperty("/dates",a);o.setProperty("/isHoliday",s);o.setProperty("/holidayName",r)},error:function(e){console.error("Error occurred while fetching holidays:",e)}})},onAddPress:function(){var e={Type:"",project:"",Phase:"",description:"",hours:{mon:"0",tue:"0",wed:"0",thu:"0",fri:"0",sat:"0",sun:"0"},totalHours:"0",AvailableHours:"0",hidingProjNam:true,flags:{hidingTextarea:true,hidingTotalInt:false}};var t=this.getView().getModel().getData();var a=t.allocations.findIndex(function(e){return!e.hidingProjNam});if(a!==-1){t.allocations.splice(a,0,e)}else{t.allocations.push(e)}this.getView().getModel().refresh(true);var s=this.byId("allocationTable");s.getBinding("items").refresh(true)},CustomerHeader:function(e){var t=e.getSource(),a=this.getView();var r=this.getOwnerComponent().getModel("oGmodel");var o=r.oData["loggedInUser"].FullName;var i=r.oData["loggedInUser"].Email;if(!this._Logoutpopover){this._Logoutpopover=s.load({id:a.getId(),name:"timesheetapplication.Fragments.Headericon",controller:this}).then(function(e){a.addDependent(e);a.byId("title").setText(o);a.byId("email").setText(i);return e})}this._Logoutpopover.then(function(e){a.byId("title").setText(o);a.byId("email").setText(i);if(e.isOpen()){e.close()}else{e.openBy(t)}})},HandleSignout:function(){this.getOwnerComponent().getRouter().navTo("RouteView");this.byId("emailInput").setValue("");this.byId("passwordInput").setValue("")},loadData:function(){var e=this.getOwnerComponent().getModel("oModel");o.view=this.getView();var s=[];o.busyDialog=new sap.m.BusyDialog;o.busyDialog.open();var r={EmployeeName:o.sName,period:o.sDateRange,Status:o.Status};e.callFunction("/RetriveTimeSheetdata",{method:"GET",urlParameters:r,success:function(e,a){var r=JSON.parse(e.RetriveTimeSheetdata);var i=r.header;s=r.items;if(s.length===0){var n={Type:"",project:"",Phase:"",description:"",hours:{mon:"0",tue:"0",wed:"0",thu:"0",fri:"0",sat:"0",sun:"0"},totalHours:"0",AvailableHours:"0",hidingProjNam:true,isDeleteButtonVisible:false,flags:{hidingTextarea:true,hidingTotalInt:false}};var l=new t({currentStartDate:this.sDateRange,dates:["","","","","","",""],isHoliday:{mon:true,tue:true,wed:true,thu:true,fri:true,sat:true,sun:true},allocations:[n]});this.getView().setModel(l);return}var g=s.slice(0,-1).map(function(e){return{Type:e.PROJECTTYPE,Project:e.PROJECTNAME,ProjectId:e.PROJECTID_PROJECTID,Phase:e.PHASE,description:e.DELIVERABLE,hours:{mon:e.MONDAY||"0",tue:e.TUESDAY||"0",wed:e.WEDNESDAY||"0",thu:e.THURSDAY||"0",fri:e.FRIDAY||"0",sat:e.SATURDAY||"0",sun:e.SUNDAY||"0"},totalHours:e.WORKINGHOURS||"0",AvailableHours:e.AVAILABLEHOURS,hidingProjNam:true,isDeleteButtonVisible:false,flags:{hidingTextarea:true,hidingTotalInt:false}}});var d=s[s.length-1];var n={project:d.PROJECTNAME||"",description:d.DELIVERABLE||"",hours:{mon:d.MONDAY||"0",tue:d.TUESDAY||"0",wed:d.WEDNESDAY||"0",thu:d.THURSDAY||"0",fri:d.FRIDAY||"0",sat:d.SATURDAY||"0",sun:d.SUNDAY||"0"},totalHours:d.WORKINGHOURS||"0",hidingProjNam:false,isDeleteButtonVisible:false,flags:{hidingTextarea:false,hidingTotalInt:true}};g.push(n);var u=o.sDateRange;var h=u.split(" - ")[0];var m=h.split(" ");var v=m[0];var c=parseInt(m[1].replace(",",""),10);var b=parseInt(m[2],10);var p={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};var f=p[v];var D=new Date(b,f,c);var w=D.toISOString();var I=new Date(w);var S=[];if(I){for(var y=0;y<7;y++){var D=new Date(I);D.setDate(I.getDate()+y);var V={month:"short",day:"numeric"};var T=D.toLocaleDateString("en-US",V);S.push(T)}}else{S=["","","","","","",""]}var E=[{key:o.sDateRange,text:o.sDateRange}];var l=new t({dateRanges:o.dateRanges,dates:S,allocations:g});o.view.setModel(l);o.view.byId("dateRangeComboBox").setSelectedKey(o.sDateRange);setTimeout(function(){o.busyDialog.close()},3e3)},error:function(e){a.show("Failed to retrieve timesheet data.")}})},_updateWeeks:function(e){var t=new Date(e);var a=[];if(t){for(var s=0;s<7;s++){var r=new Date(t);r.setDate(t.getDate()+s);a.push(this._formatDate(r))}}else{a=["","","","","","",""]}return a},onHoursChange:function(e){var t=e.getSource();var a=t.getBindingContext().getPath();var s=a.split("/").pop();var r=this.getView().getModel();var o=r.getProperty(a);var i=e.getSource().mBindingInfos.value.parts[0].path.split("/")[1];var n=t.getValue();var l=parseFloat(n);if(l<0||l>8){sap.m.MessageBox.error("Please enter a valid number between 0 and 8.");t.setValue("0");return}if(!/^0?[0-8]$/.test(n)||isNaN(l)){sap.m.MessageBox.error("Please enter a valid number between 0 and 8.");t.setValue("0");return}o.hours[i]=n;var g=0;for(var d in o.hours){g+=parseFloat(o.hours[d])||0}if(g>40){sap.m.MessageBox.error("Total hours for the week cannot exceed 40.");t.setValue("0");return}r.setProperty(a+"/totalHours",g);var u=r.getProperty("/allocations");var h=0;for(var m=0;m<u.length-1;m++){var v=u[m];h+=parseFloat(v.hours[i])||0}var c=h>8;if(c){sap.m.MessageBox.error("The total hours for "+i+" cannot exceed 8 hours.");t.setValue("0");return}var b=u.length;var p=b-1;var f="/allocations/"+p;r.setProperty(f+"/hours/"+i,h);var D=0;for(var m=0;m<u.length-1;m++){D+=u[m].totalHours||0}r.setProperty(f+"/totalHours",D)},onDeletePress:function(e){var t=this.getView().byId("allocationTable");var a=this.getView().getModel();var s=a.getProperty("/allocations");var r=e.getParameter("listItem")||e.getSource().getParent();var i=r.getBindingContextPath();var n=parseInt(i.split("/")[i.split("/").length-1]);if(n>-1&&n<s.length){s.splice(n,1);a.setProperty("/allocations",s)}t.addItem(o.oTotalRow)},loadProjectData:function(){var e=this.getOwnerComponent().getModel("oModel");var t=this;e.callFunction("/Detailsofproject",{method:"GET",success:function(e){var a=JSON.parse(e.Detailsofproject);var s=a.map(function(e){return{PROJECTID:e.PROJECTID,PROJECTNAME:e.PROJECTNAME}});var r=new sap.ui.model.json.JSONModel;r.setData(s);t.getView().setModel(r,"projectModel")},error:function(e){sap.m.MessageToast.show("Failed to load project data.")}})},onHomePress:function(){this.getOwnerComponent().getRouter().navTo("RouteViewnenu")},onBackPressTimeSheetPage:function(){this.getOwnerComponent().getRouter().navTo("Timesheetdata")},onApproved:function(){var e=this.getOwnerComponent().getModel("oGmodel");var t=e.oData["loggedInUser"].FullName;var a=new Date;var s=a.getFullYear();var r=String(a.getMonth()+1).padStart(2,"0");var i=String(a.getDate()).padStart(2,"0");var n=s+"-"+r+"-"+i;var l="Approved";var g={Status:l,EmpName:o.sName,Period:o.sDateRange,sDate:n,sSubmittedby:t};var d=JSON.stringify(g);var u=this.getOwnerComponent().getModel("oModel");u.callFunction("/TimeSheetApproved",{method:"GET",urlParameters:{data:d},success:function(e){sap.m.MessageToast.show("Timesheet Approved successfully.");this.getOwnerComponent().getRouter().navTo("Timesheetdata")}.bind(this),error:function(e){sap.m.MessageBox.error("An error occurred while Approved the timesheet status.")}})},onDelete:function(){var e={Period:o.sDateRange,EmpName:o.sName};var t=JSON.stringify(e);var a=this.getOwnerComponent().getModel("oModel");a.callFunction("/TimeSheetDelete",{method:"GET",urlParameters:{deleteddata:t},success:function(e){sap.m.MessageToast.show("Time Deleted successfully")},error:function(e){sap.m.MessageBox.error("An error occurred while Deleting the timesheet status.")}})},onSave:function(e){var t=e.getSource().getText();var a=t==="Save"?"Saved":"Submitted";this.submit(a)},submit:function(e){var t=this.getView();var s=this.getOwnerComponent().getModel("oGmodel");var r=s.oData["loggedInUser"].Email;o.sEmpID=s.oData.odata.EMPLOYEEID;var i=this.byId("dateRangeComboBox").getSelectedItem()?this.byId("dateRangeComboBox").getSelectedItem().getKey():"";var n=s.oData.loggedInUser.FullName;var l=new Date;var g=l.getFullYear();var d=String(l.getMonth()+1).padStart(2,"0");var u=String(l.getDate()).padStart(2,"0");var h=String(l.getHours()).padStart(2,"0");var m=String(l.getMinutes()).padStart(2,"0");var v=String(l.getSeconds()).padStart(2,"0");var c=`T${g}${d}${u}${h}${m}${v}`;var b=g+"-"+d+"-"+u;if(!i){sap.m.MessageBox.error("Please select a date range before submitting.");return}var p={TIMESHEETID:c,PERIOD:i,EMPLOYEENAME:n,SUBMITTEDBY:n,STATUS:e,DATE:b,EMPLOYEEID_EMPLOYEEID:o.sEmpID};var f=[];var D=this.byId("allocationTable");var w=D.getItems();var I={};for(var S=0;S<w.length;S++){var y=w[S];var V=y.getCells();var T=Date.now()%1e9+Math.floor(Math.random()*1e3);var E=parseInt(V[11].getText(),10)||0;var M=parseInt(V[12].getText(),10)||0;var P;if(e==="Submitted"&&S<w.length-1){P=M-E}if(S!==w.length-1){var R=V[1].getSelectedKey();if(!R){sap.m.MessageBox.error("Please select Project Name before submitting.");return}if(!I[R]){I[R]={totalHours:0,availableHour:M}}I[R].totalHours+=E;if(I[R].totalHours>I[R].availableHour){sap.m.MessageBox.error("Combined working hours exceed available hours for project: "+V[1].getSelectedItem().getText());return}var A=V[0].getSelectedKey();var C=V[2].getSelectedKey();if(!A){sap.m.MessageBox.error("Please select Project Type before submitting.");return}if(!C){sap.m.MessageBox.error("Please select Project Phase before submitting.");return}}var O={AUTO_INCREMENT_ID:T,TIMESHEETID:c,EMPLOYEENAME:n,PERIOD:i,PROJECTID_PROJECTID:R,PROJECTNAME:V[1].getSelectedItem()?V[1].getSelectedItem().getText():"",PROJECTTYPE:A,PHASE:C,DELIVERABLE:V[3].getItems().length>0?V[3].getItems()[0].getValue():"",MONDAY:parseInt(V[4].getValue(),10)||0,TUESDAY:parseInt(V[5].getValue(),10)||0,WEDNESDAY:parseInt(V[6].getValue(),10)||0,THURSDAY:parseInt(V[7].getValue(),10)||0,FRIDAY:parseInt(V[8].getValue(),10)||0,SATURDAY:parseInt(V[9].getValue(),10)||0,SUNDAY:parseInt(V[10].getValue(),10)||0,WORKINGHOURS:E,AvailableHours:M};f.push(O)}var N={headerData:JSON.stringify(p),itemsData:JSON.stringify(f),period:i};var x=this.getOwnerComponent().getModel("oModel");x.callFunction("/TimeSheetSubmit",{urlParameters:N,success:function(t){if(t.TimeSheetSubmit.status==="Error"){sap.m.MessageBox.error("TimeSheet already submitted for this time period")}else{a.show("Timesheet"+e+" successfully!")}},error:function(e){a.show("Error: "+e.message)}})}})});
//# sourceMappingURL=NewTimesheet.controller.js.map